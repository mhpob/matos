#' Log in to your MATOS account
#'
#' This function prompts you for the username (email) and password associated with
#' your MATOS account. This is necessary so that you may interface with any
#' project-specific files. If you don't have a MATOS account
#' \href{https://matos.asascience.com/account/signup}{you can sign up for one here}.
#'
#' A pop up will appear asking for your username and password. If everything works
#' out, your credentials will be kept in the sessions' cookies. Your username/password
#' will not be saved -- this was done intentionally so that you don't accidentally
#' save credentials in a public script.
#'
#' @export
#' @examples
#' \dontrun{
#' # Type:
#' matos_login()
#' # ...then follow the on-screen prompts
#' }

matos_login <- function(){

  # This uses a secret to allow vignettes to build and tests to run
  username <- Sys.getenv('MATOS_USER')
  password <- Sys.getenv('MATOS_PASS')

  cli::cli_alert_warning('Please log in.')

  # If no secret is present, we enter interactive mode
  if(username == ''){
    username = getPass::getPass('Username:', noblank = T)
  }
  if(password == ''){
    password = getPass::getPass('Password:', noblank = T)
  }

  credentials <- list(
    UserName = username,
    Password = password
  )

  login_response <- httr::POST(
    'https://matos.asascience.com/account/login',
    body = credentials,
    encode = 'form'
  )

  if(grepl('login', login_response)){
    cli::cli_abort('Login unsuccessful.',
                   'i' = 'Please re-run the funtion and try again.')
  } else{
    cli::cli_alert_success('Login successful!')
  }
}

#' Log out of your MATOS account
#'
#' This function takes no arguments -- just tells MATOS that you want to log out. Useful if you're changing users or on a public computer and would like to protect your projects.
#'
#' @export
#' @examples
#'  matos_logoff()

matos_logoff <- function(){
  logoff_response <- httr::GET(
    'https://matos.asascience.com/account/logoff'
  )

  cli::cli_alert_success('Logged out.')
}




#' Internal functions used by \code{matos}
#'
#' Non-exported utility functions used by other functions in \code{matos}.
#'
#' @section Details:
#' \code{get_file_list} scrapes the HTML associated with the project or data
#' extraction files page provided with a given project.
#'
#' \code{get_project_number} finds the internal MATOS number associated with each
#' project by scraping the HTML of the main MATOS projects page.
#'
#' \code{get_project_name} finds the MATOS project name associated with the given
#' project number by scraping the HTML of the main MATOS projects page.
#'
#' \code{html_table_to_df} converts the HTML table provided by \code{get_file_list}
#' into a R-usable data frame.
#'
#' \code{login_check} pings protected URLs and calls \code{matos_login} when referred
#' to the login page.
#'
#' \code{project_check}
#'
#' \code{scrape_file_urls} is used internally by \code{html_table_to_df} to extract
#' the URLs associates with each "Download" link.
#'
#' \code{download_process} is used internally by \code{get_project_file} and
#' \code{get_extract_file}
#'
#' @param project_number Number of the project
#' @param data_type one of "dataextractionfiles" or "projectfiles".
#' @param project MATOS projecct ID. Can be the name or number of the project.
#' @param project_name Character string of the full MATOS project name. This will be the
#'      big name in bold at the top of your project page, not the "Project Title"
#'      below it. Will be coerced to all lower case, so capitalization doesn't matter.
#' @param matos_projects Data frame. Used to pass the MATOS project list from
#'      \code{project_check}.
#' @param return_projects Logical. Do you want \code{project_check} to return the list
#'      of projects? Used to not ping the website too much in one function call.
#' @param url The (protected) URL that the overlapping function is trying to call.
#' @param html_file_list Listed files in HTML form. Always the result of
#' \code{get_file_list}
#' @param out_dir Character. To what directory would you like your files downloaded?
#'      Defaults to the current working directory.
#' @param overwrite Logical. Do you want to overwrite existing files that have
#'      the same name (\code{TRUE}) or protect yourself against doing this
#'      (\code{FALSE}, the default)?
#' @param to_vue Logical. Should the data be converted to match that of VUE's
#'      CSV export?
#'
#' @name utilities

get_file_list <- function(project_number, data_type){

  url <- paste('https://matos.asascience.com/project',
               data_type,
               project_number, sep = '/')

  matos:::login_check(url)

  httr::GET(url)
}



#' @rdname utilities
#'
get_project_number <- function(project_name, matos_projects = NULL){
  if(is.null(matos_projects)){
    matos_projects <- list_projects()
  }

  matos_projects_clean <- tolower(matos_projects$name)
  project_name_clean <- tolower(trimws(project_name))

  matos_projects[matos_projects_clean == project_name_clean,]$number
}


#' @rdname utilities
#'
get_project_name <- function(project_number, matos_projects = NULL){
  if(is.null(matos_projects)){
    matos_projects <- list_projects()
  }

  matos_projects[matos_projects$number == project_number,]$name
}


#' @rdname utilities
#'
html_table_to_df <- function(html_file_list){

  df <- httr::content(html_file_list, 'parsed')
  df <- rvest::html_element(df, xpath = '//*[@id="content"]/table')
  df <- rvest::html_table(df)
  df <- data.frame(df)
  names(df) <- tolower(gsub('\\.', '_', names(df)))

  df <- df[, names(df) != 'var_4']
  df$upload_date <- as.Date(df$upload_date, format = '%m/%d/%Y')

  # Make a blank data frame if there are no files to be listed.
  if(nrow(df) == 0){
    df <- cbind(df,
                data.frame(project = character(),
                           url = character())
    )

    if(grepl('dataextractionfiles', html_file_list$url)){
      df <- cbind(df,
                  data.frame(
                    detection_type = character(),
                    detection_year = numeric()
                  ))
      df <- df[, c('project', 'file_type', 'detection_type', 'detection_year',
                   'upload_date', 'file_name', 'url')]
    }else{
      df <- df[, c('project', 'file_type', 'upload_date', 'file_name', 'url')]
    }

  }else{
    # otherwise continue to parse
    df$project <- gsub('.*/', '', html_file_list$url)

    urls <- scrape_file_urls(html_file_list)

    df <- cbind(df, url = urls)

    # Parse file name for data extraction files
    if(grepl('dataextractionfiles', html_file_list$url)){
      df <- data.frame(detection_type = gsub('.*_(.*)+_detections.*', '\\1',
                                             df$file_name),
                       detection_year = as.numeric(
                         gsub('.*_|.zip', '', df$file_name)
                       ),
                       df)
      df <- df[, c('project', 'file_type', 'detection_type', 'detection_year',
                   'upload_date', 'file_name', 'url')]
    }else{
      df <- df[, c('project', 'file_type', 'upload_date', 'file_name', 'url')]
    }
  }

  df
}


#' @rdname utilities
#'
login_check <- function(url = 'https://matos.asascience.com/report/submit'){

  check_response <- httr::HEAD(url)

  if(nrow(check_response$cookies) == 1){

    matos_login()
  }

}

#' @rdname utilities
#'
project_check <- function(project, return_projects = FALSE){
  matos_projects <- list_projects()

  if(is.character(project)){
    matos_projects_clean <- tolower(matos_projects$name)
    search_project_clean <- tolower(trimws(project))

    if(!(search_project_clean %in% matos_projects_clean)){
      cli::cli_abort(paste(project,
                           'was not found among the MATOS project names.'))
    }
  }

  if(is.numeric(project)){
    if(!(project %in% matos_projects$number)){
      cli::cli_abort(paste(project,
                           'was not found among the MATOS project numbers.'))
    }
  }

  if(return_projects == TRUE){
    matos_projects
  }
}

#' @rdname utilities
#'
scrape_file_urls <- function(html_file_list){
  urls <- httr::content(html_file_list, 'parsed')
  urls <- rvest::html_node(urls, 'body')
  urls <- rvest::html_nodes(urls, 'a')
  urls <- rvest::html_attr(urls, 'href')

  urls <- grep('projectfile', urls, value = T)

  paste0('https://matos.asascience.com', urls)
}

#' @rdname utilities
#'
download_process <- function(url, out_dir, overwrite, to_vue){

  cli::cli_h1("Downloading files")

  GET_header <- httr::GET(url)

  response <-  httr::GET(
    url,
    httr::write_disk(
      path = file.path(out_dir,
                       gsub('.*filename=|\\"', '',
                            httr::headers(GET_header)$'content-disposition')),
      overwrite = overwrite)
  )

  file_loc <- file.path(response$content)

  cli::cli_alert_success('\nFile(s) saved to:')
  cat('  ', paste(file_loc, collapse = '\n   '), '\n')


  cli::cli_h1("Unzipping files")

  if(grepl('zip', file_loc)){
    file_loc <- unzip(file_loc, exdir = out_dir, setTimes = FALSE)

    cli::cli_alert_success('\nFile(s) unzipped to:')
    cat('  ', paste(file_loc, collapse = '\n   '), '\n')
  }

  if(isTRUE(to_vue)){

    cli::cli_h1("Converting to VUE CSV format")

    file_csv <- grep('.csv', file_loc, value = T)
    matos <- read.csv(
      file_csv
    )


    matos$transmitter.name <- ''
    matos$transmitter.serial <- ''

    matos <- matos[, c('datecollected', 'receiver', 'tagname', 'transmitter.name',
                       'transmitter.serial', 'sensorraw', 'sensorunit', 'station',
                       'latitude', 'longitude')]

    names(matos) <- c('Date and Time (UTC)', 'Receiver', 'Transmitter',
                      'Transmitter Name', 'Transmitter Serial', 'Sensor Value',
                      'Sensor Unit', 'Station Name', 'Latitude', 'Longitude')

    write.csv(matos, file_csv, row.names = F)
    cli::cli_alert_success('CSV converted to VUE format.')

  }

  file_loc
}


#' Place where functions live for the matos_*_summary family of functions
#'
#' @param type type of data: qualified or unqualified detections; or deployment metadata
#' @param matos_project matos project number
#' @param project_files qualified/unqualified detection files
#' @param temp_dir location of temporary directory
#'
#' @keywords internal

act_file_download <- function(type, temp_dir = NULL, matos_project = NULL,
                              project_files = NULL){
  cli::cli_alert_info(paste('Downloading', type, 'detections...'))


  if(type == 'deployment'){
    # list project files and select deployment metadata
    files <- list_project_files(matos_project)

    files <- files[grepl('Deployment', files$file_type),]
  }else{
    # select the appropriate detection type
    files <- project_files[project_files$detection_type == type,]
  }

  # ping the server and download the file(s).
  files <- lapply(files$url,
                  function(.){
                    get_extract_file(url = .,
                                     out_dir = temp_dir)
                  }
  )


  files <- unlist(files)

  if(type != 'deployment'){
    files <- grep('\\.csv$', files, value = T)
  }

  cli::cli_alert_success('   Done.')

  files
}
